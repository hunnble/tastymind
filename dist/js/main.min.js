function TaskBar(){this.taskBar=document.querySelector("#taskBar"),this.canvas=document.querySelector("#tmindCanvas"),this.lineColor="#82ECA0",this.fillColor="#000000",this.ratio=.8,this.contextmenu=new Contextmenu,this.sideBar,this.tasks=[],this.dragTask,this.focusTask,this.hasSaved=!0,this.init(),this.bindEvents()}var Nav=function(e){this.nav=document.querySelector("nav"),this.options=this.nav.querySelectorAll(".options"),this.bindEvents(),this.taskBar};Nav.prototype={bindEvents:function(){var e=this;addHandler(e.nav,"click",function(t){var a=getTarget(t);"li"==a.tagName.toLowerCase()&&([].forEach.call(e.options,function(e){e.style.display="none"}),a.querySelector(".options").style.display="block")}),addHandler(document,"click",function(t){var a=getTarget(t);"li"!==a.tagName.toLowerCase()&&[].forEach.call(e.options,function(e){e.style.display="none"})}),addHandler(e.options[0],"click",function(t){var a=getTarget(t),n=e.options[0].querySelectorAll("p"),s=e.taskBar.sideBar.sideBar.querySelector("#essential>ul"),o="tmind#name=",r=[];if(a==n[0])e.taskBar.tasks=[],e.taskBar.taskBar.innerHTML="",e.taskBar.canvas.getContext("2d").clearRect(0,0,e.taskBar.canvas.width,e.taskBar.canvas.height),s.innerHTML="",e.taskBar.hasSaved=!0;else if(a==n[1])e.taskBar.tasks&&!e.taskBar.hasSaved&&confirm("当前导图未储存,是否要储存?")&&n[2].click(),o+=prompt("请输入导图名称"),r=JSON.parse(localStorage.getItem(o)),n[0].click(),r.length>0&&(e.taskBar.hasSaved=!0,r.forEach(function(t){-1!=t.parentIndex&&(e.taskBar.focusTask=e.taskBar.tasks[t.parentIndex].node),e.taskBar.createTask({clientX:t.pos.left,clientY:t.pos.top}),e.taskBar.focusTask=null}));else if(a==n[2]){if(o+=prompt("请输入导图名"),localStorage.getItem(o)&&!confirm("已有导图,是否覆盖?"))return!1;e.taskBar.hasSaved=!0,localStorage.setItem(o,JSON.stringify(e.taskBar.tasks))}}),addHandler(e.options[1],"click",function(t){getTarget(t),e.options[1].querySelectorAll("p")}),addHandler(e.options[2],"click",function(t){getTarget(t),e.options[2].querySelectorAll("p")}),addHandler(e.options[3],"click",function(t){getTarget(t),e.options[3].querySelectorAll("p")}),addHandler(e.options[4],"click",function(t){var a,n=getTarget(t),s=e.options[4].querySelectorAll("p"),o={titleTxt:"",contentTxt:"",hasShader:!1,isShow:!0,width:400,height:300,drag:!1,flexible:!1,btns:{1:"确认",2:"取消"},returnValues:["1","0"],className:{alertWindow:"alertWindow",title:"alertWindowTitle",content:"alertWindowContent",shader:"alertWindowShader",btn:"alertWindowBtn"}};n==s[0]?(o.titleTxt="tmind",o.contentTxt="tasty mind,js开发的思维导图工具。"):(n=s[1])?(o.titleTxt="帮助",o.contentTxt="1.功能<br />2.技巧"):(n=s[2])&&(o.titleTxt="关于",o.contentTxt="作者: hunnble"),a=Hum.createClass(AlertBar,o),realDOM=a.render(),document.body?Hum.render(realDOM,document.body,function(){console.log(a.returnValue)}):Hum.render(realDOM,document.documentElement,function(){console.log(a.returnValue)})})}};var SideBar=function(){this.sideBar=document.querySelector("#sideBar"),this.taskBar,this.bindEvents()};SideBar.prototype={bindEvents:function(){var e=this;addHandler(e.sideBar,"click",function(e){var t,a,n,s,o,r=getTarget(e);"li"==r.tagName.toLowerCase()&&(a=r.parentNode.parentNode,t=a.querySelectorAll(".currentChoose"),n=r.parentNode.querySelectorAll("li"),s=a.querySelectorAll("div"),o=Array.prototype.indexOf.call(n,r),removeClassName(t[0],"currentChoose"),removeClassName(t[1],"currentChoose"),addClassName(s[o],"currentChoose"),addClassName(r,"currentChoose"))})}};var Contextmenu=function(){this.contextmenu=document.querySelector("#contextmenu"),this.options=this.contextmenu.querySelectorAll("p"),this.bindEvents()};Contextmenu.prototype={bindEvents:function(){addHandler(document,"contextmenu",function(e){preventDefault(e)})},showContextmenu:function(e){getTarget(e);e=e||window.event,this.contextmenu.style.left=e.clientX+"px",this.contextmenu.style.top=e.clientY+"px",this.contextmenu.style.display="block"}},TaskBar.prototype={init:function(){this.canvas.width=this.taskBar.offsetWidth,this.canvas.height=this.taskBar.offsetHeight},bindEvents:function(){var e=this;addHandler(document,"click",function(){e.contextmenu.contextmenu.style.display="none"}),addHandler(e.taskBar,"contextmenu",function(t){e.contextmenu.showContextmenu(t)}),addHandler(e.contextmenu.options[0],"click",function(t){t=t||window.event,e.createTask(t)}),addHandler(e.contextmenu.options[2],"click",function(t){t=t||window.event,e.removeTask(t)}),addHandler(e.taskBar,"click",function(t){var a=getTarget(t);e.focusTask&&e.focusTask!==a&&(e.focusTask.contentEditable=!1,removeClassName(e.focusTask,"focusTask"),e.focusTask=null)}),addHandler(e.taskBar,"dblclick",function(t){e.editTask(t)}),addHandler(e.taskBar,"dragstart",function(t){var a=getTarget(t);t=t||window.event,hasClassName(a,"task")&&(t.dataTransfer.setData("Url",""),e.dragTask=a)}),addHandler(e.taskBar,"dragover",function(e){preventDefault(e)}),addHandler(e.taskBar,"drop",function(t){preventDefault(t),t=t||window.event;var a,n,s=e.dragTask,o=e.taskBar.offsetLeft+s.offsetWidth/2,r=e.taskBar.offsetTop+s.offsetHeight/2;if(e.hasSaved=!1,t.clientX>o&&t.clientX<window.innerWidth-s.clientWidth/2&&t.clientY>r&&t.clientY<window.innerHeight-s.clientHeight/2){for(s.style.left=t.clientX-o+"px",s.style.top=t.clientY-r+"px",n=0,a=e.tasks.length;a>n;++n)if(e.tasks[n].node==s){e.tasks[n].pos.left=t.clientX,e.tasks[n].pos.top=t.clientY;break}for(e.canvas.getContext("2d").clearRect(0,0,e.canvas.width,e.canvas.height),n=0,a=e.tasks.length;a>n;++n)-1!=e.tasks[n].parentIndex&&e.drawBezierCurve({clientX:e.tasks[n].node.offsetLeft+e.tasks[n].node.offsetWidth/2+e.taskBar.offsetLeft,clientY:e.tasks[n].node.offsetTop+e.tasks[n].node.offsetHeight/2+e.taskBar.offsetTop},e.ratio,e.tasks[e.tasks[n].parentIndex].node)}e.screenshot()}),addHandler(e.taskBar,"keydown",function(t){t=t||window.event;var a,n,s,o,r,i=getTarget(t),l=e.sideBar.sideBar.querySelector("#essential>ul"),d=l.querySelectorAll("li"),c="";if(i==e.focusTask&&(e.hasSaved=!1,13==t.keyCode))for(e.focusTask.contentEditable=!1,removeClassName(e.focusTask,"focusTask"),e.focusTask=null,o=0,s=e.tasks.length;s>o;++o)if(e.tasks[o].node==i){if(n=0,a=e.tasks[o].parentIndex,-1!=a){for(r=findBasicTask(o,e.tasks),s=0;o>s;++s)if(-1!=e.tasks[s].parentIndex){for(k=s;-1!=e.tasks[k].parentIndex;)k=e.tasks[k].parentIndex;k==r&&++n}k=findBasicTask(o,e.tasks),d[k].querySelectorAll("p")[n].innerHTML=i.innerHTML}else{for(r=0;o>r;++r)-1==e.tasks[r].parentIndex&&++n;c="<"+d[n].innerHTML.split("<")[1],d[n].innerHTML=i.innerHTML+c}break}})},createTask:function(e){var t,a,n,s,o=this,r={},i=document.createElement("div"),l=o.taskBar.offsetLeft,d=o.taskBar.offsetTop,c=o.sideBar.sideBar.querySelector("#essential>ul");if(o.hasSaved=!1,addClassName(i,"task"),i.draggable=!0,o.taskBar.appendChild(i),i.style.left=e.clientX-l-i.offsetWidth/2+"px",i.style.top=e.clientY-d-i.offsetHeight/2+"px",i.innerHTML="主题"+(o.tasks.length+1),o.focusTask){for(a=0;a<o.tasks.length&&o.tasks[a].node!=o.focusTask;++a);for(o.drawBezierCurve(e,o.ratio,o.focusTask),r={node:i,parentIndex:a,pos:{left:e.clientX,top:e.clientY}},o.tasks.push(r),s=-1,n=0;a>=n;++n)-1==o.tasks[n].parentIndex&&++s;t=document.createElement("p"),t.innerHTML=i.innerHTML,c.querySelectorAll("li")[s].appendChild(t)}else o.tasks.push({node:i,parentIndex:-1,pos:{left:e.clientX,top:e.clientY}}),t=document.createElement("li"),t.innerHTML=i.innerHTML,c.appendChild(t);o.screenshot()},editTask:function(e){var t=this,a=getTarget(e);hasClassName(a,"task")&&(t.focusTask=a,addClassName(t.focusTask,"focusTask"),a.contentEditable=!0,a.focus(),t.screenshot())},removeTask:function(e){var t,a,n,s,o,r,i=this,l=i.focusTask,d=i.sideBar.sideBar.querySelector("#essential>ul"),c=d.querySelectorAll("li"),f=[],k=-1;if(l){for(i.hasSaved=!1,s=0,a=i.tasks.length;a>s;++s)if(i.tasks[s].node==l){if(n=0,k=i.tasks[s].parentIndex,-1!=k){for(o=findBasicTask(s,i.tasks),a=0;s>a;++a)if(-1!=i.tasks[a].parentIndex){for(r=a;-1!=i.tasks[r].parentIndex;)r=i.tasks[r].parentIndex;r==o&&++n}for(a=-1,o=0;s>o;++o)-1==i.tasks[o].parentIndex&&++a;c[a].removeChild(c[a].querySelectorAll("p")[n])}else{for(o=0;s>o;++o)-1==i.tasks[o].parentIndex&&++n;d.removeChild(c[n])}i.tasks.splice(s,1);break}for(o=0,a=i.tasks.length;a>o;++o)-1==k&&i.tasks[o].parentIndex==s?(i.tasks[o].parentIndex=-1,t=document.createElement("li"),t.innerHTML=i.tasks[o].node.innerHTML,d.appendChild(t)):i.tasks[o].parentIndex>=s&&(i.tasks[o].parentIndex-=1,-1==k&&f.push(o));for(f.forEach(function(e){var t,a=findBasicTask(e,i.tasks),n=0,s=document.createElement("p");for(t=0;a>t;++t)-1==i.tasks[t].parentIndex&&(n+=1);s.innerHTML=i.tasks[e].node.innerHTML,d.querySelectorAll("li")[n].appendChild(s)}),l.parentNode.removeChild(l),i.canvas.getContext("2d").clearRect(0,0,i.canvas.width,i.canvas.height),o=0,a=i.tasks.length;a>o;++o)i.tasks[o].parentIndex==s-1&&(i.tasks[o].parentIndex=k),-1!=i.tasks[o].parentIndex&&i.drawBezierCurve({clientX:i.tasks[o].node.offsetLeft+i.tasks[o].node.offsetWidth/2+i.taskBar.offsetLeft,clientY:i.tasks[o].node.offsetTop+i.tasks[o].node.offsetHeight/2+i.taskBar.offsetTop},i.ratio,i.tasks[i.tasks[o].parentIndex].node);i.focusTask=null,i.screenshot()}},drawBezierCurve:function(e,t,a){var n=this,s=n.canvas.getContext("2d"),o=a.offsetWidth,r=a.offsetHeight,i=a.offsetLeft+o/2,l=a.offsetTop+r/2,d=e.clientX-n.taskBar.offsetLeft,c=e.clientY-n.taskBar.offsetTop,f=d-i,k=c-l;if(!(f>-1*o&&o>f&&k>-1*r&&r>k)){f>o?(d-=o/2,i+=o/2):-1*o>f&&(d+=o/2,i-=o/2),k>r?(c-=r/2,l+=r/2):-1*r>k&&(c+=r/2,l-=r/2);var u={x:d-i,y:c-l};Math.acos(u.x/Math.sqrt(Math.pow(u.x)+Math.pow(u.y)));s.strokeStyle=n.lineColor,s.fillStyle=n.fillColor,s.lineWidth=5,s.globalCompositeOperation="source-over",s.beginPath(),s.moveTo(i,l),s.bezierCurveTo(i+(1-t)*u.x,l+t*u.y,d-t*u.x,c-(1-t)*u.y,d,c),s.stroke()}},screenshot:function(){var e,t,a=this,n=document.querySelector("#thumbnail"),s=a.canvas;html2canvas(a.taskBar,{onrendered:function(a){n.innerHTML="",e=Canvas2Image.convertToImage(a,n.offsetWidth-2,n.offsetHeight-2,"png"),t=Canvas2Image.convertToImage(s,n.offsetWidth-2,n.offsetHeight-2,"png"),n.appendChild(e),n.appendChild(t)}})}},function(){var e=new TaskBar,t=new SideBar,a=new Nav;e.sideBar=t,t.taskBar=e,a.taskBar=e}();