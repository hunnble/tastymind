function TaskBar(){this.taskBar=document.querySelector("#taskBar"),this.canvas=document.querySelector("#tmindCanvas"),this.lineColor="#82ECA0",this.fillColor="#000000",this.ratio=.8,this.contextmenu=new Contextmenu,this.sideBar,this.tasks=[],this.dragTask,this.focusTask,this.hasSaved=!0,this.init(),this.bindEvents()}var Nav=function(e){this.nav=document.querySelector("nav"),this.options=this.nav.querySelectorAll(".options"),this.bindEvents(),this.taskBar};Nav.prototype={bindEvents:function(){var e=this;addHandler(e.nav,"click",function(t){var a=getTarget(t);"li"==a.tagName.toLowerCase()&&([].forEach.call(e.options,function(e){e.style.display="none"}),a.querySelector(".options").style.display="block")}),addHandler(document,"click",function(t){var a=getTarget(t);"li"!==a.tagName.toLowerCase()&&[].forEach.call(e.options,function(e){e.style.display="none"})}),addHandler(e.options[0],"click",function(t){var a=getTarget(t),s=e.options[0].querySelectorAll("p"),n=e.taskBar.sideBar.sideBar.querySelector("#essential>ul"),o="tmind#name=",r=[];if(a==s[0])e.taskBar.tasks=[],e.taskBar.taskBar.innerHTML="",e.taskBar.canvas.getContext("2d").clearRect(0,0,e.taskBar.canvas.width,e.taskBar.canvas.height),n.innerHTML="",e.taskBar.hasSaved=!0;else if(a==s[1])e.taskBar.tasks&&!e.taskBar.hasSaved&&confirm("当前导图未储存,是否要储存?")&&s[2].click(),o+=prompt("请输入导图名称"),r=JSON.parse(localStorage.getItem(o)),s[0].click(),r.length>0&&(e.taskBar.hasSaved=!0,r.forEach(function(t){-1!=t.parentIndex&&(e.taskBar.focusTask=e.taskBar.tasks[t.parentIndex].node),e.taskBar.createTask({clientX:t.pos.left,clientY:t.pos.top}),e.taskBar.focusTask=null}));else if(a==s[2]){if(o+=prompt("请输入导图名"),localStorage.getItem(o)&&!confirm("已有导图,是否覆盖?"))return!1;e.taskBar.hasSaved=!0,localStorage.setItem(o,JSON.stringify(e.taskBar.tasks))}}),addHandler(e.options[1],"click",function(t){getTarget(t),e.options[1].querySelectorAll("p")}),addHandler(e.options[2],"click",function(t){getTarget(t),e.options[2].querySelectorAll("p")}),addHandler(e.options[3],"click",function(t){getTarget(t),e.options[3].querySelectorAll("p")}),addHandler(e.options[4],"click",function(t){var a,s=getTarget(t),n=e.options[4].querySelectorAll("p"),o={titleTxt:"",contentTxt:"",hasShader:!1,isShow:!0,width:400,height:300,drag:!1,flexible:!1,btns:{1:"确认",2:"取消"},returnValues:["1","0"],className:{alertWindow:"alertWindow",title:"alertWindowTitle",content:"alertWindowContent",shader:"alertWindowShader",btn:"alertWindowBtn"}};s==n[0]?(o.titleTxt="tmind",o.contentTxt="tasty mind,js开发的思维导图工具。"):(s=n[1])?(o.titleTxt="帮助",o.contentTxt="1.功能<br />2.技巧"):(s=n[2])&&(o.titleTxt="关于",o.contentTxt="作者: hunnble"),a=Hum.createClass(AlertBar,o),realDOM=a.render(),document.body?Hum.render(realDOM,document.body,function(){console.log(a.returnValue)}):Hum.render(realDOM,document.documentElement,function(){console.log(a.returnValue)})})}};var SideBar=function(){this.sideBar=document.querySelector("#sideBar"),this.taskBar,this.bindEvents()};SideBar.prototype={bindEvents:function(){var e=this;addHandler(e.sideBar,"click",function(e){var t,a,s,n,o,r=getTarget(e);"li"==r.tagName.toLowerCase()&&(a=r.parentNode.parentNode,t=a.querySelectorAll(".currentChoose"),s=r.parentNode.querySelectorAll("li"),n=a.querySelectorAll("div"),o=Array.prototype.indexOf.call(s,r),removeClassName(t[0],"currentChoose"),removeClassName(t[1],"currentChoose"),addClassName(n[o],"currentChoose"),addClassName(r,"currentChoose"))})}};var Contextmenu=function(){this.contextmenu=document.querySelector("#contextmenu"),this.options=this.contextmenu.querySelectorAll("p"),this.bindEvents()};Contextmenu.prototype={bindEvents:function(){addHandler(document,"contextmenu",function(e){preventDefault(e)})},showContextmenu:function(e){getTarget(e);e=e||window.event,this.contextmenu.style.left=e.clientX+"px",this.contextmenu.style.top=e.clientY+"px",this.contextmenu.style.display="block"}},TaskBar.prototype={init:function(){this.canvas.width=this.taskBar.offsetWidth,this.canvas.height=this.taskBar.offsetHeight},bindEvents:function(){var e=this;addHandler(document,"click",function(){e.contextmenu.contextmenu.style.display="none"}),addHandler(e.taskBar,"contextmenu",function(t){e.contextmenu.showContextmenu(t)}),addHandler(e.contextmenu.options[0],"click",function(t){t=t||window.event,e.createTask(t)}),addHandler(e.contextmenu.options[2],"click",function(t){t=t||window.event,e.removeTask(t)}),addHandler(e.taskBar,"click",function(t){var a=getTarget(t);e.focusTask&&e.focusTask!==a&&(e.focusTask.contentEditable=!1,removeClassName(e.focusTask,"focusTask"),e.focusTask=null)}),addHandler(e.taskBar,"dblclick",function(t){e.editTask(t)}),addHandler(e.taskBar,"dragstart",function(t){var a=getTarget(t);t=t||window.event,hasClassName(a,"task")&&(t.dataTransfer.setData("Url",""),e.dragTask=a)}),addHandler(e.taskBar,"dragover",function(e){preventDefault(e)}),addHandler(e.taskBar,"drop",function(t){preventDefault(t),t=t||window.event;var a,s,n=e.dragTask,o=e.taskBar.offsetLeft+n.offsetWidth/2,r=e.taskBar.offsetTop+n.offsetHeight/2;if(e.hasSaved=!1,t.clientX>o&&t.clientX<window.innerWidth-n.clientWidth/2&&t.clientY>r&&t.clientY<window.innerHeight-n.clientHeight/2){for(n.style.left=t.clientX-o+"px",n.style.top=t.clientY-r+"px",s=0,a=e.tasks.length;a>s;++s)if(e.tasks[s].node==n){e.tasks[s].pos.left=t.clientX,e.tasks[s].pos.top=t.clientY;break}for(e.canvas.getContext("2d").clearRect(0,0,e.canvas.width,e.canvas.height),s=0,a=e.tasks.length;a>s;++s)-1!=e.tasks[s].parentIndex&&e.drawBezierCurve({clientX:e.tasks[s].node.offsetLeft+e.tasks[s].node.offsetWidth/2+e.taskBar.offsetLeft,clientY:e.tasks[s].node.offsetTop+e.tasks[s].node.offsetHeight/2+e.taskBar.offsetTop},e.ratio,e.tasks[e.tasks[s].parentIndex].node)}}),addHandler(e.taskBar,"keydown",function(t){t=t||window.event;var a,s,n,o,r,i=getTarget(t),l=e.sideBar.sideBar.querySelector("#essential>ul"),d=l.querySelectorAll("li"),c="";if(i==e.focusTask&&(e.hasSaved=!1,13==t.keyCode))for(e.focusTask.contentEditable=!1,removeClassName(e.focusTask,"focusTask"),e.focusTask=null,o=0,n=e.tasks.length;n>o;++o)if(e.tasks[o].node==i){if(s=0,a=e.tasks[o].parentIndex,-1!=a){for(r=findBasicTask(o,e.tasks),n=0;o>n;++n)if(-1!=e.tasks[n].parentIndex){for(k=n;-1!=e.tasks[k].parentIndex;)k=e.tasks[k].parentIndex;k==r&&++s}k=findBasicTask(o,e.tasks),d[k].querySelectorAll("p")[s].innerHTML=i.innerHTML}else{for(r=0;o>r;++r)-1==e.tasks[r].parentIndex&&++s;c="<"+d[s].innerHTML.split("<")[1],d[s].innerHTML=i.innerHTML+c}break}})},createTask:function(e){var t,a,s,n,o=this,r={},i=document.createElement("div"),l=o.taskBar.offsetLeft,d=o.taskBar.offsetTop,c=o.sideBar.sideBar.querySelector("#essential>ul");if(o.hasSaved=!1,addClassName(i,"task"),i.draggable=!0,o.taskBar.appendChild(i),i.style.left=e.clientX-l-i.offsetWidth/2+"px",i.style.top=e.clientY-d-i.offsetHeight/2+"px",i.innerHTML="主题"+(o.tasks.length+1),o.focusTask){for(a=0;a<o.tasks.length&&o.tasks[a].node!=o.focusTask;++a);for(o.drawBezierCurve(e,o.ratio,o.focusTask),r={node:i,parentIndex:a,pos:{left:e.clientX,top:e.clientY}},o.tasks.push(r),n=-1,s=0;a>=s;++s)-1==o.tasks[s].parentIndex&&++n;t=document.createElement("p"),t.innerHTML=i.innerHTML,c.querySelectorAll("li")[n].appendChild(t)}else o.tasks.push({node:i,parentIndex:-1,pos:{left:e.clientX,top:e.clientY}}),t=document.createElement("li"),t.innerHTML=i.innerHTML,c.appendChild(t)},editTask:function(e){var t=this,a=getTarget(e);hasClassName(a,"task")&&(t.focusTask=a,addClassName(t.focusTask,"focusTask"),a.contentEditable=!0,a.focus())},removeTask:function(e){var t,a,s,n,o,r=this,i=r.focusTask,l=r.sideBar.sideBar.querySelector("#essential>ul"),d=l.querySelectorAll("li"),c=-1;if(i){for(r.hasSaved=!1,s=0,t=r.tasks.length;t>s;++s)if(r.tasks[s].node==i){if(a=0,c=r.tasks[s].parentIndex,-1!=c){for(n=findBasicTask(s,r.tasks),t=0;s>t;++t)if(-1!=r.tasks[t].parentIndex){for(o=t;-1!=r.tasks[o].parentIndex;)o=r.tasks[o].parentIndex;o==n&&++a}for(t=-1,n=0;s>n;++n)-1==r.tasks[n].parentIndex&&++t;d[t].removeChild(d[t].querySelectorAll("p")[a])}else{for(n=0;s>n;++n)-1==r.tasks[n].parentIndex&&++a;l.removeChild(d[a])}r.tasks.splice(s,1);break}for(n=0,t=r.tasks.length;t>n;++n)n>=s&&r.tasks[n].parentIndex==c?r.tasks[n].parentIndex=-1:r.tasks[n].parentIndex>=s&&(r.tasks[n].parentIndex-=1);for(i.parentNode.removeChild(i),r.canvas.getContext("2d").clearRect(0,0,r.canvas.width,r.canvas.height),n=0,t=r.tasks.length;t>n;++n)r.tasks[n].parentIndex==s-1&&(r.tasks[n].parentIndex=c),-1!=r.tasks[n].parentIndex&&r.drawBezierCurve({clientX:r.tasks[n].node.offsetLeft+r.tasks[n].node.offsetWidth/2+r.taskBar.offsetLeft,clientY:r.tasks[n].node.offsetTop+r.tasks[n].node.offsetHeight/2+r.taskBar.offsetTop},r.ratio,r.tasks[r.tasks[n].parentIndex].node);r.focusTask=null}},drawBezierCurve:function(e,t,a){var s=this,n=s.canvas.getContext("2d"),o=a.offsetWidth,r=a.offsetHeight,i=a.offsetLeft+o/2,l=a.offsetTop+r/2,d=e.clientX-s.taskBar.offsetLeft,c=e.clientY-s.taskBar.offsetTop,f=d-i,k=c-l;if(!(f>-1*o&&o>f&&k>-1*r&&r>k)){f>o?(d-=o/2,i+=o/2):-1*o>f&&(d+=o/2,i-=o/2),k>r?(c-=r/2,l+=r/2):-1*r>k&&(c+=r/2,l-=r/2);var u={x:d-i,y:c-l};Math.acos(u.x/Math.sqrt(Math.pow(u.x)+Math.pow(u.y)));n.strokeStyle=s.lineColor,n.fillStyle=s.fillColor,n.lineWidth=5,n.globalCompositeOperation="source-over",n.beginPath(),n.moveTo(i,l),n.bezierCurveTo(i+(1-t)*u.x,l+t*u.y,d-t*u.x,c-(1-t)*u.y,d,c),n.stroke()}}},function(){var e=new TaskBar,t=new SideBar,a=new Nav;e.sideBar=t,t.taskBar=e,a.taskBar=e}();