function TaskBar(){this.taskBar=document.querySelector("#taskBar"),this.canvas=document.querySelector("#tmindCanvas"),this.lineColor="#82ECA0",this.fillColor="#000000",this.taskHeight=40,this.taskWidth=100,this.ratio=.8,this.lineWidth=3,this.contextmenu=new Contextmenu,this.sideBar,this.tasks=[],this.dragTask,this.focusTask,this.hasSaved=!0,this.defaultWord="",this.init(),this.bindEvents()}var Nav=function(e){this.nav=document.querySelector("nav"),this.options=this.nav.querySelectorAll(".options"),this.bindEvents(),this.taskBar};Nav.prototype={bindEvents:function(){var e=this;addHandler(e.nav,"click",function(t){var a=getTarget(t);"li"==a.tagName.toLowerCase()&&([].forEach.call(e.options,function(e){removeClassName(e,"show")}),addClassName(a.querySelector(".options"),"show"))}),addHandler(document,"click",function(t){var a=getTarget(t);"li"!==a.tagName.toLowerCase()&&[].forEach.call(e.options,function(e){removeClassName(e,"show")})}),addHandler(e.options[0],"click",function(t){var a=getTarget(t),s=e.options[0].querySelectorAll("p"),n=e.taskBar.sideBar.sideBar.querySelector("#essential>ul"),r=e.taskBar.sideBar.sideBar.querySelector("#thumbnail"),o="tmind#name=",i=[];if(!hasClassName(e.options[0],"show"))return!1;if(a==s[0])e.taskBar.tasks.length>0&&!e.taskBar.hasSaved&&confirm("当前导图未储存,是否要储存?")&&s[2].click(),e.taskBar.tasks=[],e.taskBar.taskBar.innerHTML="",e.taskBar.canvas.getContext("2d").clearRect(0,0,e.taskBar.canvas.width,e.taskBar.canvas.height),n.innerHTML="",r.innerHTML="",e.taskBar.hasSaved=!0;else if(a==s[1]){if(o+=prompt("请输入导图名称"),!localStorage.getItem(o))return alert("导图不存在"),!1;i=JSON.parse(localStorage.getItem(o)),s[0].click(),i.length>0&&(e.taskBar.hasSaved=!0,i.forEach(function(t){-1!=t.parentIndex&&(e.taskBar.focusTask=e.taskBar.tasks[t.parentIndex].node),e.taskBar.createTask({clientX:t.pos.left,clientY:t.pos.top}),e.taskBar.focusTask=null}))}else a==s[2]&&e.taskBar.saveMind(o)}),addHandler(e.options[1],"click",function(t){getTarget(t),e.options[1].querySelectorAll("p");return hasClassName(e.options[1],"show")?void 0:!1}),addHandler(e.options[2],"click",function(t){getTarget(t),e.options[2].querySelectorAll("p");return hasClassName(e.options[2],"show")?void 0:!1}),addHandler(e.options[3],"click",function(t){var a,s=getTarget(t),n=e.options[3].querySelectorAll("p"),r=e.taskBar.taskBar.offsetWidth-2,o=e.taskBar.taskBar.offsetHeight-2;return hasClassName(e.options[3],"show")?void(s==n[0]&&html2canvas(e.taskBar.taskBar,{onrendered:function(t){t.getContext("2d").drawImage(e.taskBar.canvas,0,0),a=Canvas2Image.saveAsPNG(t,r,o)}})):!1}),addHandler(e.options[4],"click",function(t){var a,s,n=getTarget(t),r=e.options[4].querySelectorAll("p");return hasClassName(e.options[4],"show")?(s={titleTxt:"",contentTxt:"",hasShader:!1,isShow:!0,width:400,height:300,drag:!1,flexible:!1,btns:{1:"确认",2:"取消"},returnValues:["1","0"],className:{alertWindow:"alertWindow",title:"alertWindowTitle",content:"alertWindowContent",shader:"alertWindowShader",btn:"alertWindowBtn"}},n==r[0]?(s.titleTxt="tmind",s.contentTxt="tasty mind,js开发的思维导图工具。"):n==r[1]?(s.titleTxt="帮助",s.contentTxt='1.<a href="#">功能</a><br />快速创作思维导图，支持导出图片和主题切换。<br />2.<a href="#">技巧</a>'):n==r[2]&&(s.titleTxt="关于",s.contentTxt='作者: hunnble<br /><a href="https://github.com/hunnble/tastymind">github</a>'),a=Hum.createClass(AlertBar,s),realDOM=a.render(),void(document.body?Hum.render(realDOM,document.body,function(){console.log(a.returnValue)}):Hum.render(realDOM,document.documentElement,function(){console.log(a.returnValue)}))):!1})}};var SideBar=function(){this.sideBar=document.querySelector("#sideBar"),this.taskBar,this.bindEvents()};SideBar.prototype={bindEvents:function(){var e=this,t=e.sideBar.querySelector("#fontSize"),a=e.sideBar.querySelector("#ligature");addHandler(e.sideBar,"click",function(t){var a,s,n,r,o,i=getTarget(t);e.sideBar.querySelectorAll(".theme");"li"==i.tagName.toLowerCase()?(s=i.parentNode.parentNode,a=s.querySelectorAll(".currentChoose"),n=i.parentNode.querySelectorAll("li"),r=s.querySelectorAll("div"),o=Array.prototype.indexOf.call(n,i),removeClassName(a[0],"currentChoose"),removeClassName(a[1],"currentChoose"),addClassName(r[o],"currentChoose"),addClassName(i,"currentChoose"),e.taskBar.screenshot()):hasClassName(i,"theme")&&(e.taskBar.taskBar.style.backgroundColor=getStyle(i,"backgroundColor"),e.taskBar.taskBar.style.color=getStyle(i,"color"),e.taskBar.taskBar.style.borderColor=getStyle(i,"color"),e.taskBar.screenshot())}),addHandler(t,"change",function(){e.taskBar.taskBar.style.fontSize=t.value,e.taskBar.screenshot()}),addHandler(a,"change",function(){e.taskBar.ratio=a.value,e.taskBar.renderCanvas(),e.taskBar.screenshot()})}};var Contextmenu=function(){this.contextmenu=document.querySelector("#contextmenu"),this.options=this.contextmenu.querySelectorAll("p"),this.bindEvents()};Contextmenu.prototype={bindEvents:function(){addHandler(document,"contextmenu",function(e){preventDefault(e)})},showContextmenu:function(e){getTarget(e);e=e||window.event,this.contextmenu.style.left=e.clientX+"px",this.contextmenu.style.top=e.clientY+"px",this.contextmenu.style.display="block"}},TaskBar.prototype={init:function(){this.canvas.width=this.taskBar.offsetWidth,this.canvas.height=this.taskBar.offsetHeight},bindEvents:function(){var e=this;addHandler(document,"click",function(){e.contextmenu.contextmenu.style.display="none"}),addHandler(e.taskBar,"contextmenu",function(t){e.contextmenu.showContextmenu(t)}),addHandler(e.contextmenu.options[0],"click",function(t){t=t||window.event,e.createTask(t)}),addHandler(e.contextmenu.options[2],"click",function(t){t=t||window.event,e.removeTask(t)}),addHandler(e.contextmenu.options[3],"click",function(){e.saveMind()}),addHandler(e.taskBar,"click",function(t){var a,s,n,r=getTarget(t);if(t=t||window.event,e.focusTask&&e.focusTask!==r){if(hasClassName(r,"task")&&t.altKey){for(n=0,s=e.tasks.length;s>n;++n)if(e.tasks[n].node==e.focusTask){a=n;break}for(n=0,s=e.tasks.length;s>n;++n)if(e.tasks[n].node==r){e.tasks[n].relatives.push(a),e.tasks[a].relatives.push(n);break}e.renderCanvas()}else e.focusTask.innerHTML=e.defaultWord,e.focusTask.contentEditable=!1,removeClassName(e.focusTask,"focusTask"),e.focusTask=null;e.screenshot()}}),addHandler(e.taskBar,"dblclick",function(t){e.editTask(t),e.screenshot()}),addHandler(e.taskBar,"dragstart",function(t){var a=getTarget(t);t=t||window.event,hasClassName(a,"task")&&(t.dataTransfer.setData("Url",""),e.dragTask=a)}),addHandler(e.taskBar,"dragover",function(e){preventDefault(e)}),addHandler(e.taskBar,"drop",function(t){preventDefault(t),t=t||window.event;var a,s,n=e.dragTask,r=e.taskBar.offsetLeft+n.offsetWidth/2,o=e.taskBar.offsetTop+n.offsetHeight/2;if(e.hasSaved=!1,t.clientX>r&&t.clientX<window.innerWidth-n.clientWidth/2&&t.clientY>o&&t.clientY<window.innerHeight-n.clientHeight/2)for(n.style.left=t.clientX-r+"px",n.style.top=t.clientY-o+"px",s=0,a=e.tasks.length;a>s;++s)if(e.tasks[s].node==n){e.tasks[s].pos.left=t.clientX,e.tasks[s].pos.top=t.clientY;break}e.renderCanvas(),e.screenshot()}),addHandler(e.taskBar,"keydown",function(t){t=t||window.event;var a,s,n,r,o,i=getTarget(t),l=e.sideBar.sideBar.querySelector("#essential>ul"),d=l.querySelectorAll("li"),c="";if(i==e.focusTask&&(e.hasSaved=!1,13==t.keyCode)){for(""==e.focusTask.innerHTML&&(e.focusTask.innerHTML="--"),e.focusTask.contentEditable=!1,removeClassName(e.focusTask,"focusTask"),e.focusTask=null,r=0,n=e.tasks.length;n>r;++r)if(e.tasks[r].node==i){if(s=0,a=e.tasks[r].parentIndex,-1!=a){for(o=findBasicTask(r,e.tasks).resultIndex,n=0;r>n;++n)if(-1!=e.tasks[n].parentIndex){for(k=n;-1!=e.tasks[k].parentIndex;)k=e.tasks[k].parentIndex;k==o&&++s}k=findBasicTask(r,e.tasks).resultIndex,d[k].querySelectorAll("p")[s].innerHTML=i.innerHTML}else{for(o=0;r>o;++o)-1==e.tasks[o].parentIndex&&++s;c="<"+d[s].innerHTML.split("<").slice(1).join("<"),d[s].innerHTML=i.innerHTML+("<"==c?"":c)}break}e.screenshot()}})},createTask:function(e){var t,a,s,n,r,o=this,i={},l=document.createElement("div"),d=o.taskBar.offsetLeft,c=o.taskBar.offsetTop,f=o.sideBar.sideBar.querySelector("#essential>ul");if(o.hasSaved=!1,l.draggable=!0,l.style.width=o.taskWidth+"px",l.style.top=e.clientY-c-o.taskHeight/2+"px",l.style.left=e.clientX-d-o.taskWidth/2+"px",l.innerHTML="主题"+(o.tasks.length+1),addClassName(l,"task"),o.taskBar.appendChild(l),o.focusTask){for(s=0;s<o.tasks.length&&o.tasks[s].node!=o.focusTask;++s);for(o.drawBezierCurve(e,o.ratio,o.focusTask),i={node:l,parentIndex:s,relatives:[],pos:{left:e.clientX,top:e.clientY}},o.tasks.push(i),a=findBasicTask(s,o.tasks).resultIndex,r=0,n=0;a>n;++n)-1==o.tasks[n].parentIndex&&++r;t=document.createElement("p"),t.innerHTML=l.innerHTML,f.querySelectorAll("li")[r].appendChild(t)}else o.tasks.push({node:l,parentIndex:-1,relatives:[],pos:{left:e.clientX,top:e.clientY}}),t=document.createElement("li"),t.innerHTML=l.innerHTML,f.appendChild(t);o.screenshot()},editTask:function(e){var t=this,a=getTarget(e);hasClassName(a,"task")?(t.focusTask=a,t.defaultWord=a.innerHTML,addClassName(t.focusTask,"focusTask"),a.contentEditable=!0,a.focus(),t.screenshot()):t.defaultWord=""},removeTask:function(e){var t,a,s,n,r,o,i=this,l=i.focusTask,d=i.sideBar.sideBar.querySelector("#essential>ul"),c=d.querySelectorAll("li"),f=[],k=-1,u=0;if(l){for(i.hasSaved=!1,n=0,a=i.tasks.length;a>n;++n)if(i.tasks[n].node==l){if(s=0,k=i.tasks[n].parentIndex,-1!=k){for(r=findBasicTask(n,i.tasks).resultIndex,a=0;n>a;++a)-1!=i.tasks[a].parentIndex&&(o=findBasicTask(a,i.tasks).resultIndex,o==r&&++s);for(o=findBasicTask(n,i.tasks).resultIndex,a=0,r=0;o>r;++r)-1==i.tasks[r].parentIndex&&++a;c[a].removeChild(c[a].querySelectorAll("p")[s])}else{for(r=0;n>r;++r)-1==i.tasks[r].parentIndex&&++u;d.removeChild(c[u])}i.tasks.splice(n,1);break}for(r=0,a=i.tasks.length;a>r;++r)i.tasks[r].relatives.forEach(function(e,t){e==n?i.tasks[r].relatives.splice(n,1):e>n&&(i.tasks[r].relatives[t]-=1)});for(r=0,a=i.tasks.length;a>r;++r)-1==k&&i.tasks[r].parentIndex==n?(i.tasks[r].parentIndex=-1,t=document.createElement("li"),t.innerHTML=i.tasks[r].node.innerHTML,d.insertBefore(t,c[u+1])):-1!=k&&i.tasks[r].parentIndex==n?i.tasks[r].parentIndex=k:i.tasks[r].parentIndex>=n&&(i.tasks[r].parentIndex-=1,-1==k&&f.push(r));for(f.forEach(function(e){var t,a=findBasicTask(e,i.tasks).resultIndex,s=0,n=document.createElement("p");for(t=0;a>t;++t)-1==i.tasks[t].parentIndex&&(s+=1);n.innerHTML=i.tasks[e].node.innerHTML,d.querySelectorAll("li")[s].appendChild(n)}),l.parentNode.removeChild(l),r=0,a=i.tasks.length;a>r;++r)i.tasks[r].parentIndex==n-1&&(i.tasks[r].parentIndex=k);i.renderCanvas(),i.focusTask=null,i.screenshot()}},drawBezierCurve:function(e,t,a,s){var n=this,r=n.canvas.getContext("2d"),o=a.offsetWidth,i=a.offsetHeight,l=a.offsetLeft+o/2,d=a.offsetTop+i/2,c=e.clientX-n.taskBar.offsetLeft,f=e.clientY-n.taskBar.offsetTop,k=c-l,u=f-d;if(!(k>-1*o&&o>k&&u>-1*i&&i>u)){k>o?(c-=o/2,l+=o/2):-1*o>k&&(c+=o/2,l-=o/2),u>i?(f-=i/2,d+=i/2):-1*i>u&&(f+=i/2,d-=i/2);var h={x:c-l,y:f-d};angle=Math.acos(h.x/Math.sqrt(Math.pow(h.x)+Math.pow(h.y))),r.strokeStyle=n.lineColor,r.fillStyle=n.fillColor,r.lineWidth=n.lineWidth,r.globalCompositeOperation="source-over",r.beginPath(),r.moveTo(l,d),s||(r.arc(l,d,5,0,2*Math.PI,!1),r.fill()),r.bezierCurveTo(l+(1-t)*h.x,d+t*h.y,c-t*h.x,f-(1-t)*h.y,c,f),r.stroke()}},renderCanvas:function(){var e,t,a=this;for(a.canvas.getContext("2d").clearRect(0,0,a.canvas.width,a.canvas.height),t=0,e=a.tasks.length;e>t;++t)-1!=a.tasks[t].parentIndex&&a.drawBezierCurve({clientX:a.tasks[t].node.offsetLeft+a.tasks[t].node.offsetWidth/2+a.taskBar.offsetLeft,clientY:a.tasks[t].node.offsetTop+a.tasks[t].node.offsetHeight/2+a.taskBar.offsetTop},a.ratio,a.tasks[a.tasks[t].parentIndex].node),a.tasks[t].relatives.forEach(function(e){e>t&&a.drawBezierCurve({clientX:a.tasks[t].node.offsetLeft+a.tasks[t].node.offsetWidth/2+a.taskBar.offsetLeft,clientY:a.tasks[t].node.offsetTop+a.tasks[t].node.offsetHeight/2+a.taskBar.offsetTop},a.ratio,a.tasks[e].node,!0)})},screenshot:function(){var e,t,a=this,s=document.querySelector("#thumbnail"),n=a.canvas;html2canvas(a.taskBar,{onrendered:function(a){s.innerHTML="",e=Canvas2Image.convertToImage(a,s.offsetWidth-2,s.offsetHeight-2,"png"),t=Canvas2Image.convertToImage(n,s.offsetWidth-2,s.offsetHeight-2,"png"),s.appendChild(e),s.appendChild(t)}})},saveMind:function(e){var t=this,a=prompt("请输入导图名");return!a||"undefined"!=localStorage.getItem(e)&&!confirm("已有导图,是否覆盖?")?!1:(e+=a,t.hasSaved=!0,void localStorage.setItem(e,JSON.stringify(t.tasks)))}},function(){var e=new TaskBar,t=new SideBar,a=new Nav;e.sideBar=t,t.taskBar=e,a.taskBar=e}();