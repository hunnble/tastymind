function TaskBar(){this.taskBar=document.querySelector("#taskBar"),this.canvas=document.querySelector("#tmindCanvas"),this.lineColor="#666666",this.fillColor="#000000",this.ratio=.8,this.contextmenu=new Contextmenu,this.sideBar,this.tasks=[],this.dragTask,this.focusTask,this.init(),this.bindEvents()}TaskBar.prototype.init=function(){this.canvas.width=this.taskBar.offsetWidth,this.canvas.height=this.taskBar.offsetHeight},TaskBar.prototype.bindEvents=function(){var t=this;addHandler(document,"click",function(){t.contextmenu.contextmenu.style.display="none"}),addHandler(t.taskBar,"contextmenu",function(e){t.contextmenu.showContextmenu(e)}),addHandler(t.contextmenu.options[0],"click",function(e){e=e||window.event,t.createTask(e)}),addHandler(t.contextmenu.options[2],"click",function(e){t.removeTask(e)}),addHandler(t.taskBar,"click",function(e){var a=getTarget(e);t.focusTask&&t.focusTask!==a&&(t.focusTask.contentEditable=!1,removeClassName(t.focusTask,"focusTask"),t.focusTask=null)}),addHandler(t.taskBar,"dblclick",function(e){t.editTask(e)}),addHandler(t.taskBar,"dragstart",function(e){var a=getTarget(e);e=e||window.event,hasClassName(a,"task")&&(e.dataTransfer.setData("Url",""),t.dragTask=a)}),addHandler(t.taskBar,"dragover",function(t){preventDefault(t)}),addHandler(t.taskBar,"drop",function(e){preventDefault(e),e=e||window.event;var a,s,n=t.dragTask,o=t.taskBar.offsetLeft+n.offsetWidth/2,r=t.taskBar.offsetTop+n.offsetHeight/2;if(e.clientX>o&&e.clientX<window.innerWidth-n.clientWidth/2&&e.clientY>r&&e.clientY<window.innerHeight-n.clientHeight/2)for(n.style.left=e.clientX-o+"px",n.style.top=e.clientY-r+"px",t.canvas.getContext("2d").clearRect(0,0,t.canvas.width,t.canvas.height),s=0,a=t.tasks.length;a>s;++s)-1!=t.tasks[s].parentIndex&&t.drawBezierCurve({clientX:t.tasks[s].node.offsetLeft+t.tasks[s].node.offsetWidth/2+t.taskBar.offsetLeft,clientY:t.tasks[s].node.offsetTop+t.tasks[s].node.offsetHeight/2+t.taskBar.offsetTop},t.ratio,t.tasks[t.tasks[s].parentIndex].node)}),addHandler(t.taskBar,"keydown",function(e){e=e||window.event;var a=getTarget(e);a==t.focusTask&&13==e.keyCode&&(t.focusTask.contentEditable=!1,removeClassName(t.focusTask,"focusTask"),t.focusTask=null)})},TaskBar.prototype.createTask=function(t){var e,a=this,s={},n=document.createElement("div"),o=a.taskBar.offsetLeft,r=a.taskBar.offsetTop;if(addClassName(n,"task"),n.draggable=!0,a.taskBar.appendChild(n),n.style.left=t.clientX-o-n.offsetWidth/2+"px",n.style.top=t.clientY-r-n.offsetHeight/2+"px",n.innerHTML="主题"+(a.tasks.length+1),a.focusTask){for(e=0;e<a.tasks.length&&a.tasks[e].node!=a.focusTask;++e);a.drawBezierCurve(t,a.ratio,a.focusTask),s={node:n,parentIndex:e},a.tasks.push(s)}else a.tasks.push({node:n,parentIndex:-1})},TaskBar.prototype.editTask=function(t){var e=this,a=getTarget(t);hasClassName(a,"task")&&(e.focusTask=a,addClassName(e.focusTask,"focusTask"),a.contentEditable=!0,a.focus())},TaskBar.prototype.removeTask=function(t){var e,a,s,n=this,o=n.focusTask;if(o){for(a=0,e=n.tasks.length;e>a;++a)if(n.tasks[a].node==o){n.tasks.splice(a,1);break}for(s=0,e=n.tasks.length;e>s;++s)n.tasks[s].parentIndex>=a&&(n.tasks[s].parentIndex-=1);for(o.parentNode.removeChild(o),n.canvas.getContext("2d").clearRect(0,0,n.canvas.width,n.canvas.height),s=0,e=n.tasks.length;e>s;++s)-1!=n.tasks[s].parentIndex&&n.drawBezierCurve({clientX:n.tasks[s].node.offsetLeft+n.tasks[s].node.offsetWidth/2+n.taskBar.offsetLeft,clientY:n.tasks[s].node.offsetTop+n.tasks[s].node.offsetHeight/2+n.taskBar.offsetTop},n.ratio,n.tasks[n.tasks[s].parentIndex].node);n.focusTask=null}},TaskBar.prototype.drawBezierCurve=function(t,e,a){var s=this,n=s.canvas.getContext("2d"),o=a.offsetLeft+a.offsetWidth/2,r=a.offsetTop+a.offsetHeight/2,i=t.clientX-s.taskBar.offsetLeft,f=t.clientY-s.taskBar.offsetTop,d={x:i-o,y:f-r};Math.acos(d.x/Math.sqrt(Math.pow(d.x)+Math.pow(d.y)));n.strokeStyle=s.lineColor,n.fillStyle=s.fillColor,n.globalCompositeOperation="source-over",n.beginPath(),n.moveTo(o,r),n.bezierCurveTo(o+(1-e)*d.x,r+e*d.y,i-e*d.x,f-(1-e)*d.y,i,f),n.stroke()};